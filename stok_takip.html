<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Takip (Giriş/Çıkış)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; }
        .header { background-color: #7098e2; color: white; padding: 15px; display: flex; justify-content: space-between; }
        .nav-links a { color: white; margin-left: 15px; text-decoration: none; font-weight: bold; }
        
        .container { max-width: 900px; margin: 20px auto; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .mode-selection { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 4px; opacity: 0.6; }
        .mode-btn.active { opacity: 1; transform: scale(1.02); }
        .btn-in { background-color: #28a745; color: white; }
        .btn-out { background-color: #dc3545; color: white; }

        .search-area { position: relative; margin-bottom: 20px; }
        #skuSearch { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .suggestions { position: absolute; width: 100%; background: white; border: 1px solid #ddd; z-index: 10; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .suggestion-item:hover { background-color: #f0f8ff; }

        .transaction-list { margin-top: 20px; }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f9f9f9; border-bottom: 1px solid #eee; margin-bottom: 5px; }
        .qty-input { width: 60px; padding: 5px; text-align: center; }
        .remove-btn { color: red; cursor: pointer; font-weight: bold; font-size: 1.2em; margin-right: 10px; }
        
        #processBtn { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; color: white; background-color: #333; border: none; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <div>Stok Takip & Hareket</div>
        <div class="nav-links">
            <a href="index.html">Ana Sayfa</a>
            <a href="stok_ekle.html">+ Yeni Ürün</a>
        </div>
    </div>

    <div class="container">
        <div class="mode-selection">
            <button class="mode-btn btn-in active" onclick="setMode('in')">Stok Giriş (Ekle)</button>
            <button class="mode-btn btn-out" onclick="setMode('out')">Stok Çıkış (Düş)</button>
        </div>

        <div class="search-area">
            <input type="text" id="skuSearch" placeholder="Ürün Ara (Stok Kodu veya Model yazın...)">
            <div id="suggestions" class="suggestions"></div>
        </div>

        <h3>İşlem Listesi:</h3>
        <div class="transaction-list" id="transactionList">
            <p style="color:gray; text-align:center;">Henüz ürün eklenmedi.</p>
        </div>

        <button id="processBtn" onclick="processTransaction()">İşlemi Tamamla (Stoka Ekle)</button>
        <p id="resultMsg" style="text-align: center; font-weight: bold; margin-top: 10px;"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSCuSjLtRxCicBpiYE4zV_CQ6iF23CMos",
            authDomain: "ceit133-mses.firebaseapp.com",
            databaseURL: "https://ceit133-mses-default-rtdb.firebaseio.com",
            projectId: "ceit133-mses",
            appId: "1:803859950218:web:48b897035bb041d1799b73"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let currentUser = null;
        let allProducts = [];
        let basket = []; // Seçilen ürünler
        let currentMode = 'in'; // 'in' veya 'out'

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = 'login.html';
            currentUser = user;
        });

        // Ürünleri hafızaya al (Arama için)
        onValue(ref(db, 'products'), (snapshot) => {
            allProducts = [];
            snapshot.forEach(child => {
                allProducts.push({ key: child.key, ...child.val() });
            });
        });

        window.setMode = (mode) => {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if(mode === 'in') {
                document.querySelector('.btn-in').classList.add('active');
                document.getElementById('processBtn').innerText = "İşlemi Tamamla (Stoka Ekle)";
                document.getElementById('processBtn').style.backgroundColor = "#28a745";
            } else {
                document.querySelector('.btn-out').classList.add('active');
                document.getElementById('processBtn').innerText = "İşlemi Tamamla (Stoktan Düş)";
                document.getElementById('processBtn').style.backgroundColor = "#dc3545";
            }
        };

        // Arama ve Autocomplete
        const searchInput = document.getElementById('skuSearch');
        const suggestionsBox = document.getElementById('suggestions');

        searchInput.addEventListener('input', () => {
            const val = searchInput.value.toLowerCase();
            suggestionsBox.innerHTML = '';
            if (val.length < 2) { suggestionsBox.style.display = 'none'; return; }

            const matches = allProducts.filter(p => 
                (p.sku && p.sku.toLowerCase().includes(val)) || 
                (p.model && p.model.toLowerCase().includes(val))
            ).slice(0, 10);

            if (matches.length > 0) {
                suggestionsBox.style.display = 'block';
                matches.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = `${p.sku} - ${p.brand} ${p.model}`;
                    div.onclick = () => addToBasket(p);
                    suggestionsBox.appendChild(div);
                });
            } else {
                suggestionsBox.style.display = 'none';
            }
        });

        function addToBasket(product) {
            // Sepette var mı kontrol et
            const exists = basket.find(item => item.key === product.key);
            if (!exists) {
                basket.push({ ...product, listQty: 0 });
            }
            renderBasket();
            searchInput.value = '';
            suggestionsBox.style.display = 'none';
        }

        window.removeFromBasket = (index) => {
            basket.splice(index, 1);
            renderBasket();
        };

        window.updateBasketQty = (index, val) => {
            basket[index].listQty = parseInt(val);
        };

        function renderBasket() {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';
            if (basket.length === 0) {
                list.innerHTML = '<p style="color:gray; text-align:center;">Henüz ürün eklenmedi.</p>';
                return;
            }

            basket.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span class="remove-btn" onclick="removeFromBasket(${index})">X</span>
                        <strong>${item.sku}</strong> &nbsp; <small>(${item.brand} ${item.model}) Mevcut: ${item.stock_quantity}</small>
                    </div>
                    <div>
                        <input type="number" class="qty-input" min="1" value="${item.listQty}" onchange="updateBasketQty(${index}, this.value)">
                    </div>
                `;
                list.appendChild(div);
            });
        }

        window.processTransaction = async () => {
            if (basket.length === 0) return alert("Listeye ürün ekleyin.");
            
            // İşlemler
            const updates = {};
            const logList = [];
            let error = false;

            basket.forEach(item => {
                if (item.listQty <= 0) { error = true; return; }
                
                let newStock = item.stock_quantity;
                if (currentMode === 'in') newStock += item.listQty;
                else newStock -= item.listQty;

                if (newStock < 0) {
                    alert(`Hata: ${item.sku} için stok eksiye düşemez!`);
                    error = true;
                    return;
                }

                // Database update object construction
                updates[`products/${item.key}/stock_quantity`] = newStock;
                
                // Log object construction
                logList.push({
                    sku: item.sku,
                    qty: item.listQty,
                    oldStock: item.stock_quantity,
                    newStock: newStock
                });
            });

            if (error) return;

            // Log kaydını oluştur
            const transactionLog = {
                page: 'stok_takip',
                date: new Date().toLocaleString('tr-TR'),
                user: currentUser.email,
                action: currentMode === 'in' ? 'Stok Giriş' : 'Stok Çıkış',
                items: logList
            };

            // Firebase'e yaz
            try {
                await update(ref(db), updates); // Stokları güncelle
                await push(ref(db, 'transactions'), transactionLog); // Log kaydet
                
                document.getElementById('resultMsg').innerText = `İşlem Başarılı! Toplam ${basket.length} kalem güncellendi.`;
                document.getElementById('resultMsg').style.color = "green";
                basket = [];
                renderBasket();
            } catch (err) {
                alert("Hata oluştu: " + err.message);
            }
        };
    </script>
</body>
</html>