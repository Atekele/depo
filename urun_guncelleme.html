<!doctype html>
<html>
<head>
  <title>Stok Takip | MSES</title>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <link href="css/frame.css" rel="stylesheet" type="text/css" />
  <style>
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .card img { max-width: 100%; height: 150px; object-fit: contain; }
    .qty-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; }
    .btn-qty { padding: 10px 15px; font-size: 20px; cursor: pointer; border: none; border-radius: 5px; }
    .plus { background: #28a745; color: white; }
    .minus { background: #dc3545; color: white; }
    .stock-val { font-size: 24px; font-weight: bold; }
    #searchInp { width: 90%; padding: 10px; margin: 20px; border-radius: 20px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div class="menu">
    <div class="menu-table flex-row-space-between">
      <div class="logo"><a href="index.html">MSES</a></div>
      <div class="menu-items">
        <a href="index.html">Panel</a>
        <a href="ProductUpdate.html" style="font-weight:bold;">Stok Takip</a>
        <a href="NewProduct.html">+ Yeni Ürün</a>
      </div>
    </div>
  </div>

  <input type="text" id="searchInp" placeholder="Marka, Model veya Renk Ara...">
  <div id="productGrid" class="grid"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBSCuSjLtRxCicBpiYE4zV_CQ6iF23CMos",
      authDomain: "ceit133-mses.firebaseapp.com",
      databaseURL: "https://ceit133-mses-default-rtdb.firebaseio.com",
      projectId: "ceit133-mses",
      storageBucket: "ceit133-mses.appspot.com",
      appId: "1:803859950218:web:48b897035bb041d1799b73"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const grid = document.getElementById('productGrid');
    const search = document.getElementById('searchInp');

    onValue(ref(db, 'products'), (snapshot) => {
      renderProducts(snapshot);
    });

    function renderProducts(snapshot) {
      grid.innerHTML = "";
      snapshot.forEach(child => {
        const p = child.val();
        const key = child.key;
        const searchTerm = search.value.toLowerCase();
        
        if(p.brand.toLowerCase().includes(searchTerm) || p.model.toLowerCase().includes(searchTerm)) {
          grid.innerHTML += `
            <div class="card">
              <img src="${p.image_url || 'img/no-image.png'}">
              <h3>${p.brand} ${p.model}</h3>
              <p>${p.wheel_size} Jant - ${p.color}</p>
              <p><b>Satış: ${p.sell_price} ₺</b></p>
              <div class="qty-controls">
                <button class="btn-qty minus" onclick="changeQty('${key}', -1)">-</button>
                <span class="stock-val" id="qty-${key}">${p.stock_quantity}</span>
                <button class="btn-qty plus" onclick="changeQty('${key}', 1)">+</button>
              </div>
            </div>
          `;
        }
      });
    }

    window.changeQty = (key, amt) => {
      const el = document.getElementById(`qty-${key}`);
      let newQty = parseInt(el.innerText) + amt;
      if(newQty < 0) newQty = 0;
      update(ref(db, `products/${key}`), { stock_quantity: newQty });
    };

    search.oninput = () => {
      onValue(ref(db, 'products'), renderProducts, { onlyOnce: true });
    };
  </script>
</body>
</html>
