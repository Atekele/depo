<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ürün Güncelleme</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
        .card { background: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .inputs input { width: 70px; padding: 5px; margin: 0 5px; }
        .btn { padding: 5px 10px; cursor: pointer; color: white; border: none; border-radius: 3px; }
        .btn-upd { background: #007bff; }
        .btn-del { background: #dc3545; }
    </style>
</head>
<body>
    <a href="index.html">Ana Sayfa</a> | <a href="islemler.html">İşlemler</a>
    <h2>Ürün Güncelleme ve Silme</h2>
    <div id="list">Yükleniyor...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        // DİKKAT: Loglama için 'push' ve 'get' import edilmeli
        import { getDatabase, ref, onValue, update, remove, push, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSCuSjLtRxCicBpiYE4zV_CQ6iF23CMos",
            authDomain: "ceit133-mses.firebaseapp.com",
            databaseURL: "https://ceit133-mses-default-rtdb.firebaseio.com",
            projectId: "ceit133-mses",
            appId: "1:803859950218:web:48b897035bb041d1799b73"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if(!user) window.location.href='login.html';
            currentUser = user;
        });

        const listDiv = document.getElementById('list');

        onValue(ref(db, 'products'), (snapshot) => {
            listDiv.innerHTML = '';
            snapshot.forEach(child => {
                const p = child.val();
                const k = child.key;
                const html = `
                    <div class="card">
                        <div style="width:200px;">
                            <strong>${p.sku}</strong><br>
                            <small>${p.brand} ${p.model}</small>
                        </div>
                        <div class="inputs">
                            Alış: <input id="buy_${k}" type="number" value="${p.buy_price}">
                            Satış: <input id="sell_${k}" type="number" value="${p.sell_price}">
                            <button class="btn btn-upd" onclick="window.doUpdate('${k}', '${p.sku}')">Güncelle</button>
                        </div>
                        <button class="btn btn-del" onclick="window.doDelete('${k}')">SİL</button>
                    </div>
                `;
                listDiv.innerHTML += html;
            });
        });

        // Fonksiyonları window'a tanımlıyoruz ki HTML'den çağrılabilsin
        window.doUpdate = (key, sku) => {
            const newBuy = document.getElementById('buy_'+key).value;
            const newSell = document.getElementById('sell_'+key).value;

            update(ref(db, 'products/'+key), {
                buy_price: newBuy, 
                sell_price: newSell
            }).then(() => {
                // LOGLAMA KISMI
                const log = {
                    action: "Fiyat Güncelleme",
                    user: currentUser.email,
                    date: new Date().toLocaleString('tr-TR'),
                    page: "urun_guncelleme",
                    details: `<strong>${sku}</strong> fiyatları değişti. Alış:${newBuy}, Satış:${newSell}`
                };
                push(ref(db, 'transactions'), log); // Log gönder
                alert("Güncellendi!");
            });
        };

        window.doDelete = (key) => {
            if(!confirm("Bu ürünü silmek istediğine emin misin?")) return;

            // Önce ürünü oku ki loga yazabilelim
            get(ref(db, 'products/'+key)).then(snap => {
                const p = snap.val();
                const sku = p ? p.sku : 'Bilinmiyor';

                remove(ref(db, 'products/'+key)).then(() => {
                    // LOGLAMA KISMI
                    const log = {
                        action: "Ürün Silme",
                        user: currentUser.email,
                        date: new Date().toLocaleString('tr-TR'),
                        page: "urun_guncelleme",
                        details: `SİLİNEN ÜRÜN: <strong>${sku}</strong>`
                    };
                    push(ref(db, 'transactions'), log); // Log gönder
                    alert("Silindi!");
                });
            });
        };
    </script>
</body>
</html>
