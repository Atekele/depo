<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni Ürün Ekle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* GENEL STİL */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; }
        .header { background-color: #7098e2; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 1.2rem; }
        .nav-links a { color: white; text-decoration: none; margin-left: 15px; font-weight: bold; font-size: 0.9rem; }
        
        .container { max-width: 800px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        
        .row { display: flex; gap: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }

        button.save-btn { width: 100%; background-color: #28a745; color: white; padding: 15px; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; margin-top: 10px; }
        button.save-btn:hover { background-color: #218838; }

        .hidden { display: none; }
        .new-entry-input { margin-top: 5px; border-color: #7098e2; }

        #skuPreview { background-color: #e9ecef; color: #495057; font-weight: bold; cursor: not-allowed; }
        #statusMsg { text-align: center; margin-bottom: 15px; font-weight: bold; }
        
        /* Mobil Menü */
        @media (max-width: 600px) {
            .nav-links { display: flex; flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Stok Ekle</h1>
        <div class="nav-links">
            <a href="index.html">Ana Sayfa</a>
            <a href="stok_takip.html">Stok Takip</a>
            <a href="islemler.html">İşlemler</a>
        </div>
    </div>

    <div class="container">
        <div id="statusMsg"></div>
        <form id="productForm">
            
            <div class="form-group">
                <label>Ürün Türü:</label>
                <select id="typeSelect" required>
                    <option value="">Seçiniz...</option>
                    <option value="Bisiklet">Bisiklet</option>
                    <option value="Akülü Araba">Akülü Araba</option>
                    <option value="Elektrikli Bisiklet">Elektrikli Bisiklet</option>
                    <option value="Üç Tekerli">Üç Tekerli</option>
                    <option value="Traktör">Traktör</option>
                    <option value="Scooter">Scooter</option>
                    <option value="Diğer">Diğer</option>
                </select>
            </div>

            <div class="row">
                <div class="col form-group">
                    <label>Marka:</label>
                    <select id="brandSelect" disabled required><option value="">Önce Tür Seçin</option></select>
                </div>
                <div class="col form-group">
                    <label>Model:</label>
                    <select id="modelSelect" disabled required><option value="">Önce Marka Seçin</option></select>
                </div>
            </div>

            <div class="form-group hidden" id="wheelGroup">
                <label>Jant Boyutu (Sadece Bisiklet):</label>
                <select id="wheelSelect">
                    <option value="">Seçiniz...</option>
                    <option value="12">12</option><option value="13">13</option><option value="14">14</option>
                    <option value="15">15</option><option value="16">16</option><option value="20">20</option>
                    <option value="24">24</option><option value="26">26</option><option value="27.5">27.5</option>
                    <option value="28">28</option><option value="29">29</option>
                </select>
            </div>

            <div class="row">
                <div class="col form-group">
                    <label>Renk:</label>
                    <select id="colorSelect" required>
                        <option value="Kırmızı">Kırmızı</option>
                        <option value="Mavi">Mavi</option>
                        <option value="Pembe">Pembe</option>
                        <option value="Yeşil">Yeşil</option>
                        <option value="YENI_EKLE">+ Yeni Renk Ekle</option>
                    </select>
                    <input type="text" id="customColor" class="new-entry-input hidden" placeholder="Yeni Renk Yazın">
                </div>
                <div class="col form-group">
                    <label>Fren Tipi (Varsa):</label>
                    <select id="brakeSelect" required>
                        <option value="V">V</option>
                        <option value="2D">2D</option>
                        <option value="HD">HD</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col form-group">
                    <label>Vites (Opsiyonel):</label>
                    <select id="gearSelect">
                        <option value="">Yok</option>
                        <option value="21">21</option><option value="24">24</option>
                        <option value="10">10</option><option value="7">7</option>
                        <option value="6">6</option><option value="Kelebek">Kelebek</option>
                        <option value="Çevirmeli">Çevirmeli</option>
                        <option value="YENI_EKLE">+ Yeni Ekle</option>
                    </select>
                    <input type="text" id="customGear" class="new-entry-input hidden" placeholder="Yeni Vites Yazın">
                </div>
                <div class="col form-group">
                    <label>Kadro (Opsiyonel):</label>
                    <select id="frameSelect">
                        <option value="">Yok</option>
                        <option value="12">12</option><option value="14">14</option><option value="16">16</option>
                        <option value="18">18</option><option value="20">20</option><option value="38">38</option>
                        <option value="41">41</option><option value="43">43</option><option value="46">46</option>
                        <option value="48">48</option><option value="51">51</option><option value="52">52</option>
                        <option value="56">56</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Stok Kodu (Otomatik):</label>
                <input type="text" id="skuPreview" readonly>
                <small style="color:gray;">Formül: Jant + Model + Renk + Fren</small>
            </div>

            <div class="row">
                <div class="col form-group">
                    <label>Alış Fiyatı (₺):</label>
                    <input type="number" id="buyPrice" step="0.01" min="0" required>
                </div>
                <div class="col form-group">
                    <label>Satış Fiyatı (₺):</label>
                    <input type="number" id="sellPrice" step="0.01" min="0" required>
                </div>
                <div class="col form-group">
                    <label>Stok Adedi:</label>
                    <input type="number" id="quantity" min="0" value="1" required>
                </div>
            </div>

            <button type="submit" class="save-btn">Ürünü Kaydet</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSCuSjLtRxCicBpiYE4zV_CQ6iF23CMos",
            authDomain: "ceit133-mses.firebaseapp.com",
            databaseURL: "https://ceit133-mses-default-rtdb.firebaseio.com",
            projectId: "ceit133-mses",
            appId: "1:803859950218:web:48b897035bb041d1799b73"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = 'login.html';
            currentUser = user;
        });

        // --- VERİ KATALOĞU (Marka ve Modeller) ---
        const catalog = {
            "Bisiklet": {
                "Ümit": ["Alpina", "Explore", "Motion", "Solaris", "Mirage", "Arcus", "Faster", "Stallion", "Blackrider", "Blackmount", "Magnetic", "Ventura", "Valencia", "Alanya", "Stitch", "Safiro", "Ktlnr-Twenty one", "Ktlnr-Asos", "Ktlnr-Cunda", "Rock", "Luna", "Crosser", "Picalo", "Princess", "Racer", "Mia", "Actress", "Trend-y", "Hotshot", "Hawai", "Speedo", "Joy"],
                "Carraro": ["Daytona911", "Daytona930", "Daytona927", "Force970", "Force950", "Force920", "Force770", "Force600", "Sportive225", "Sportive224", "Active280"],
                "Mosso": ["Cavalier Sora", "Cavalier Claris", "BlackEdition", "Wildfire", "Raceline", "Legarda", "Marine"],
                "Cenix": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"],
                "Mito": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"],
                "Root": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"],
                "Kron": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"],
                "Geroni": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"],
                "Belderia": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"],
                "Totem": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"],
                "Falcon": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"],
                "Corelli": ["Çift amortisörlü", "Ön Amortisörlü", "Düz"]
            },
            "Elektrikli Bisiklet": {
                "Ümit": ["Altec"],
                "Mosso": ["Arkas", "Freya", "Magnera", "Hydra", "Alley", "Horizon"],
                "Carraro": ["E-Life", "E-Comfort", "E-Lorry", "E-Go"],
                "Rks": ["Alfa Romeo"]
            },
            "Akülü Araba": {
                "Babyhope": ["441 Quattro", "439 BHU", "437 Suv", "445 Sport", "444 Mercedes", "443 IşıklıTeker", "442 Jaguar", "436 Audi", "440 Bugo"],
                "Baby 2 go": ["441 Quattro", "439 BHU", "437 Suv"],
                "Pilsan": ["Arizona", "Attack", "Panter", "Ranger", "Rocket", "Traktör"],
                "Cool Wheels": ["Cool Wheels"]
            },
            "Üç Tekerli": {
                "Ümit": ["Yupi", "Panda", "Kety", "Hakan", "Prens"],
                "Pilsan": ["Yunus", "Atom"]
            },
            "Traktör": {
                "Pilsan": ["Pilsan"]
            },
            "Scooter": {
                "Ümit": ["İnce Teker JY-H01", "Kalın Teker JY-H02"],
                "Cool Wheels": ["Tulpar +3", "Cortix+3", "Maxi +6", "Nova"],
                "Void": ["Void"],
                "Prego": ["Oturaklı", "Kontrollü"]
            },
            "Diğer": {
                "Diğer": ["Diğer"],
                "F-Sports": ["Kask", "Paten", "Kask-Set", "Kaykay"]
            }
        };

        // DOM Elementleri
        const typeSelect = document.getElementById('typeSelect');
        const brandSelect = document.getElementById('brandSelect');
        const modelSelect = document.getElementById('modelSelect');
        const wheelGroup = document.getElementById('wheelGroup');
        const wheelSelect = document.getElementById('wheelSelect');
        const colorSelect = document.getElementById('colorSelect');
        const customColor = document.getElementById('customColor');
        const brakeSelect = document.getElementById('brakeSelect');
        const gearSelect = document.getElementById('gearSelect');
        const customGear = document.getElementById('customGear');
        const skuPreview = document.getElementById('skuPreview');
        const statusMsg = document.getElementById('statusMsg');

        // Dinamik Seçimler
        typeSelect.addEventListener('change', () => {
            const type = typeSelect.value;
            brandSelect.innerHTML = '<option value="">Marka Seçiniz</option>';
            modelSelect.innerHTML = '<option value="">Model Seçiniz</option>';
            brandSelect.disabled = true;
            modelSelect.disabled = true;

            if (type === "Bisiklet") {
                wheelGroup.classList.remove('hidden');
            } else {
                wheelGroup.classList.add('hidden');
                wheelSelect.value = "";
            }

            if (type && catalog[type]) {
                Object.keys(catalog[type]).forEach(brand => {
                    brandSelect.innerHTML += `<option value="${brand}">${brand}</option>`;
                });
                brandSelect.disabled = false;
            }
            generateSKU();
        });

        brandSelect.addEventListener('change', () => {
            const type = typeSelect.value;
            const brand = brandSelect.value;
            modelSelect.innerHTML = '<option value="">Model Seçiniz</option>';
            modelSelect.disabled = true;

            if (type && brand && catalog[type][brand]) {
                catalog[type][brand].forEach(model => {
                    modelSelect.innerHTML += `<option value="${model}">${model}</option>`;
                });
                modelSelect.disabled = false;
            }
            generateSKU();
        });

        // Custom Input Göster/Gizle
        colorSelect.addEventListener('change', () => {
            customColor.classList.toggle('hidden', colorSelect.value !== 'YENI_EKLE');
            generateSKU();
        });
        customColor.addEventListener('input', generateSKU);
        
        gearSelect.addEventListener('change', () => {
            customGear.classList.toggle('hidden', gearSelect.value !== 'YENI_EKLE');
        });

        modelSelect.addEventListener('change', generateSKU);
        wheelSelect.addEventListener('change', generateSKU);
        brakeSelect.addEventListener('change', generateSKU);

        function generateSKU() {
            const wheel = wheelSelect.value;
            const model = modelSelect.value;
            let color = colorSelect.value;
            if (color === 'YENI_EKLE') color = customColor.value;
            const brake = brakeSelect.value;

            // Formül: Jant + Model + Renk + Fren (Boşluksuz)
            // Eğer jant yoksa (Bisiklet değilse) sadece Model+Renk+Fren
            let sku = "";
            if (wheel) sku += wheel;
            if (model) sku += model;
            if (color) sku += color;
            if (brake) sku += brake;

            // Boşlukları temizle ve Türkçe karakterleri düzelt (isteğe bağlı, burada basit tutuyoruz)
            skuPreview.value = sku.replace(/\s/g, '');
        }

        // Form Gönderme
        document.getElementById('productForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            let finalColor = colorSelect.value === 'YENI_EKLE' ? customColor.value : colorSelect.value;
            let finalGear = gearSelect.value === 'YENI_EKLE' ? customGear.value : gearSelect.value;
            const finalSKU = skuPreview.value;

            if (!finalSKU) {
                alert("Stok Kodu oluşturulamadı. Lütfen tüm alanları seçiniz.");
                return;
            }

            const productData = {
                type: typeSelect.value,
                brand: brandSelect.value,
                model: modelSelect.value,
                wheel_size: wheelSelect.value || "",
                color: finalColor,
                brake_type: brakeSelect.value,
                gear: finalGear || "",
                frame: document.getElementById('frameSelect').value || "",
                sku: finalSKU,
                buy_price: parseFloat(document.getElementById('buyPrice').value),
                sell_price: parseFloat(document.getElementById('sellPrice').value),
                stock_quantity: parseInt(document.getElementById('quantity').value),
                created_at: Date.now(),
                created_by: currentUser.email
            };

            const newProductRef = push(ref(db, 'products'));
            set(newProductRef, productData)
                .then(() => {
                    statusMsg.style.color = "green";
                    statusMsg.innerText = "Yeni ürün başarıyla kaydedildi! (" + finalSKU + ")";
                    document.getElementById('productForm').reset();
                    // Reset custom inputs
                    customColor.classList.add('hidden');
                    customGear.classList.add('hidden');
                    wheelGroup.classList.add('hidden');
                    skuPreview.value = "";
                })
                .catch((err) => {
                    statusMsg.style.color = "red";
                    statusMsg.innerText = "Hata: " + err.message;
                });
        });
    </script>
</body>
</html>