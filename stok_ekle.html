<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni Ürün Ekle</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .nav-links a { margin-left: 10px; text-decoration: none; color: #333; font-weight: bold; }
        
        select, input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        label { font-weight: bold; display: block; margin-top: 10px; }
        .hidden { display: none; }
        .save-btn { width: 100%; background: #28a745; color: white; padding: 15px; border: none; font-size: 18px; cursor: pointer; border-radius: 4px; margin-top: 20px; }
        #statusMsg { padding: 10px; margin-bottom: 15px; border-radius: 4px; font-weight: bold; text-align: center; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Yeni Ürün Ekle</h2>
            <div class="nav-links">
                <a href="index.html">Ana Sayfa</a>
                <a href="islemler.html">İşlemler</a>
            </div>
        </div>

        <div id="statusMsg"></div>

        <form id="productForm">
            <label>Tür:</label>
            <select id="typeSelect" required>
                <option value="">Seçiniz...</option>
                <option value="Bisiklet">Bisiklet</option>
                <option value="Akülü Araba">Akülü Araba</option>
                <option value="Elektrikli Bisiklet">Elektrikli Bisiklet</option>
                <option value="Üç Tekerli">Üç Tekerli</option>
                <option value="Traktör">Traktör</option>
                <option value="Scooter">Scooter</option>
                <option value="Diğer">Diğer</option>
            </select>

            <label>Marka:</label>
            <select id="brandSelect" disabled required><option value="">Önce Tür Seçin</option></select>

            <label>Model:</label>
            <select id="modelSelect" disabled required><option value="">Önce Marka Seçin</option></select>

            <div id="wheelGroup" class="hidden">
                <label>Jant (Sadece Bisiklet):</label>
                <select id="wheelSelect">
                    <option value="">Seç...</option>
                    <option value="12">12</option><option value="16">16</option><option value="20">20</option>
                    <option value="24">24</option><option value="26">26</option><option value="27.5">27.5</option><option value="28">28</option><option value="29">29</option>
                </select>
            </div>

            <label>Renk:</label>
            <select id="colorSelect" required>
                <option value="Kırmızı">Kırmızı</option><option value="Mavi">Mavi</option>
                <option value="Siyah">Siyah</option><option value="Beyaz">Beyaz</option>
                <option value="YENI_EKLE">+ Yeni Ekle</option>
            </select>
            <input type="text" id="customColor" class="hidden" placeholder="Yeni Renk Yazın">

            <label>Fren:</label>
            <select id="brakeSelect" required><option value="V">V</option><option value="HD">HD</option><option value="MD">MD</option></select>

            <label>Kadro:</label>
            <select id="frameSelect"><option value="">Yok</option><option value="46">46</option><option value="51">51</option></select>

            <label>Stok Kodu (Otomatik):</label>
            <input type="text" id="skuPreview" readonly style="background:#eee; font-weight:bold;">

            <label>Alış Fiyatı:</label><input type="number" id="buyPrice" value="0">
            <label>Satış Fiyatı:</label><input type="number" id="sellPrice" value="0">
            <label>Stok Adedi:</label><input type="number" id="quantity" value="1">

            <button type="submit" class="save-btn">KAYDET</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        // DİKKAT: 'push' fonksiyonu import edildi, bu olmadan kayıt atmaz.
        import { getDatabase, ref, push, set, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSCuSjLtRxCicBpiYE4zV_CQ6iF23CMos",
            authDomain: "ceit133-mses.firebaseapp.com",
            databaseURL: "https://ceit133-mses-default-rtdb.firebaseio.com",
            projectId: "ceit133-mses",
            appId: "1:803859950218:web:48b897035bb041d1799b73"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = 'login.html';
            currentUser = user;
        });

        // KATALOG (Kısaltıldı, mantık aynı)
        const catalog = {
             "Bisiklet": {"Ümit": ["Alpina", "Pegasus"], "Carraro": ["Sportive"]},
             "Akülü Araba": {"Pilsan": ["Ranger"]},
             // ... Diğer tüm markaları buraya eklediğini varsayıyorum, önceki koddan kopyalayabilirsin
        };

        // DOM Elementleri
        const ids = ['typeSelect', 'brandSelect', 'modelSelect', 'wheelSelect', 'colorSelect', 'customColor', 'brakeSelect', 'frameSelect', 'skuPreview', 'statusMsg', 'wheelGroup'];
        const el = {};
        ids.forEach(id => el[id] = document.getElementById(id));

        // Event Listeners
        el.typeSelect.addEventListener('change', () => {
            el.brandSelect.innerHTML = '<option value="">Marka Seç</option>';
            el.brandSelect.disabled = false;
            // Basit katalog doldurma
            if(catalog[el.typeSelect.value]) {
                Object.keys(catalog[el.typeSelect.value]).forEach(m => el.brandSelect.innerHTML += `<option>${m}</option>`);
            }
            if(el.typeSelect.value === 'Bisiklet') el.wheelGroup.classList.remove('hidden');
            else el.wheelGroup.classList.add('hidden');
        });

        el.brandSelect.addEventListener('change', () => {
            el.modelSelect.innerHTML = '<option value="">Model Seç</option>';
            el.modelSelect.disabled = false;
            const models = catalog[el.typeSelect.value][el.brandSelect.value];
            if(models) models.forEach(m => el.modelSelect.innerHTML += `<option>${m}</option>`);
        });

        el.colorSelect.addEventListener('change', () => {
            if(el.colorSelect.value === 'YENI_EKLE') el.customColor.classList.remove('hidden');
            else el.customColor.classList.add('hidden');
            generateSKU();
        });
        
        [el.modelSelect, el.wheelSelect, el.brakeSelect, el.frameSelect, el.customColor].forEach(item => {
            item.addEventListener('change', generateSKU);
            item.addEventListener('input', generateSKU);
        });

        function generateSKU() {
            let color = el.colorSelect.value === 'YENI_EKLE' ? el.customColor.value : el.colorSelect.value;
            let sku = (el.wheelSelect.value + el.modelSelect.value + color + el.brakeSelect.value + el.frameSelect.value).replace(/\s/g, '');
            el.skuPreview.value = sku;
        }

        // --- KAYIT İŞLEMİ (Loglama BURADA) ---
        document.getElementById('productForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const sku = el.skuPreview.value;
            if(!sku) return alert("SKU oluşmadı");

            el.statusMsg.style.display = 'block';
            el.statusMsg.innerText = "Kaydediliyor...";
            el.statusMsg.style.background = "yellow";

            const q = query(ref(db, 'products'), orderByChild('sku'), equalTo(sku));
            get(q).then((snapshot) => {
                if(snapshot.exists()) {
                    el.statusMsg.innerText = "HATA: Bu ürün zaten var!";
                    el.statusMsg.style.background = "red";
                    el.statusMsg.style.color = "white";
                } else {
                    // Ürün Verisi
                    const productData = {
                        type: el.typeSelect.value,
                        brand: el.brandSelect.value,
                        model: el.modelSelect.value,
                        sku: sku,
                        stock_quantity: parseInt(document.getElementById('quantity').value),
                        buy_price: document.getElementById('buyPrice').value,
                        sell_price: document.getElementById('sellPrice').value,
                        color: el.colorSelect.value === 'YENI_EKLE' ? el.customColor.value : el.colorSelect.value,
                        created_at: Date.now()
                    };

                    // 1. Ürünü Kaydet
                    const newRef = push(ref(db, 'products'));
                    set(newRef, productData).then(() => {
                        
                        // 2. LOG KAYDI OLUŞTUR (İşte burası İşlemler sayfasına gönderir)
                        const logData = {
                            action: "Stok Giriş (Yeni Ürün)",
                            user: currentUser.email,
                            date: new Date().toLocaleString('tr-TR'),
                            page: "stok_ekle",
                            details: `Yeni Ürün: <strong>${sku}</strong> eklendi.`
                        };
                        push(ref(db, 'transactions'), logData); // LOGU GÖNDER

                        el.statusMsg.innerText = "BAŞARILI! Kaydedildi.";
                        el.statusMsg.style.background = "green";
                        el.statusMsg.style.color = "white";
                        document.getElementById('productForm').reset();
                    });
                }
            });
        });
    </script>
</body>
</html>
