<!doctype html>
<html>
<head>
  <title>Yeni Ürün Ekle | MSES Stok</title>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <link href="css/frame.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/controls.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/custom.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <style>
    .menu { background-color: #7098e2; }
    .input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .input-group label { width: 110px; font-weight: bold; }
    .input-group select, .input-group input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex: 1; min-width: 150px; max-width: 300px; }
    .btn-add { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    
    @media (max-width: 850px) {
      .input-group { display: block; border-bottom: 1px solid #eee; padding-bottom: 10px; }
      .input-group label { display: block; margin-bottom: 5px; }
      .input-group select, .input-group input { width: 100%; max-width: none; margin-bottom: 5px; }
      .menu-items { display: none; flex-direction: column; width: 100%; position: absolute; top: 50px; left: 0; background-color: #7098e2; z-index: 50; }
      .menu-items.active { display: flex; }
    }
  </style>
</head>
<body>

  <div class="menu">
    <div class="menu-table flex-row-space-between">
      <div class="logo flex-row-center"><a href="index.html">MSES</a></div>
      <a class="menu-button" href="javascript:void(0)"><img src="img/menu.png"></a>
      <div class="menu-items flex-row-center flex-item">
        <a href="index.html">Ana Panel</a>
        <a href="ProductUpdate.html">Stok Takip</a>
        <a href="NewProduct.html" style="font-weight: 700;">+ Yeni Ürün</a>
        <button id="signOutButton" class="menu-help">Çıkış Yap</button>
      </div>
    </div>
  </div>

  <div class="content">
    <h1>Yeni Ürün Kaydı</h1>
    <p id="uploadStatus"></p>

    <form id="productForm">
      <div class="input-group">
        <label>Ürün Türü:</label>
        <select id="typeSelect" required>
          <option value="Bisiklet">Bisiklet</option>
          <option value="Akülü Araba">Akülü Araba</option>
          <option value="Elektrikli Bisiklet">Elektrikli Bisiklet</option>
          <option value="Diğer">Diğer</option>
        </select>
      </div>

      <div class="input-group">
        <label>Marka:</label>
        <select id="brandSelect" required></select>
        <input type="text" id="brandInput" placeholder="Yeni Marka..." style="display:none;">
        <button type="button" id="btnBrandAdd" class="btn-add" style="display:none;">Ekle</button>
      </div>

      <div class="input-group">
        <label>Model:</label>
        <select id="modelSelect" required></select>
        <input type="text" id="modelInput" placeholder="Yeni Model..." style="display:none;">
        <button type="button" id="btnModelAdd" class="btn-add" style="display:none;">Ekle</button>
      </div>

      <div class="input-group">
        <label id="labelWheel">Jant/Ölçü:</label>
        <select id="wheelSelect">
          <option value="12">12 Jant</option>
          <option value="16">16 Jant</option>
          <option value="20">20 Jant</option>
          <option value="24">24 Jant</option>
          <option value="26">26 Jant</option>
          <option value="27.5">27.5 Jant</option>
          <option value="28">28 Jant</option>
          <option value="29">29 Jant</option>
          <option value="6V">6 Volt (Akülü)</option>
          <option value="12V">12 Volt (Akülü)</option>
        </select>
      </div>

      <div class="input-group">
        <label>Renk:</label>
        <select id="colorSelect" required></select>
        <input type="text" id="colorInput" placeholder="Yeni Renk..." style="display:none;">
        <button type="button" id="btnColorAdd" class="btn-add" style="display:none;">Ekle</button>
      </div>

      <div class="input-group">
        <label>Alış Fiyatı:</label>
        <input type="number" id="buyPrice" step="0.01" value="0">
      </div>
      <div class="input-group">
        <label>Satış Fiyatı:</label>
        <input type="number" id="sellPrice" step="0.01" value="0">
      </div>
      <div class="input-group">
        <label>Stok Adedi:</label>
        <input type="number" id="stockQty" value="1">
      </div>

      <div class="input-group">
        <label>Görsel:</label>
        <input type="file" id="imageInput" accept="image/*" capture="camera">
      </div>

      <button type="submit" style="background-color: #28a745; color: white; padding: 12px; width: 100%; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">Ürünü Sisteme Kaydet</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBSCuSjLtRxCicBpiYE4zV_CQ6iF23CMos",
      authDomain: "ceit133-mses.firebaseapp.com",
      databaseURL: "https://ceit133-mses-default-rtdb.firebaseio.com",
      projectId: "ceit133-mses",
      storageBucket: "ceit133-mses.appspot.com",
      appId: "1:803859950218:web:48b897035bb041d1799b73"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // HAZIR VERİ SETİ (Carraro, Mosso ve Belgenizdeki Modeller)
    const presetData = {
      "Carraro": ["Daytona 909", "Daytona 910", "Daytona 709", "Force 900", "Force 920", "Force 970C", "Force 700", "Sportive 724", "Flexi 108", "Big Bang"],
      "Mosso": ["Cavalier Sora", "Cavalier Claris", "Legarda 2221", "Legarda 2224", "Wildfire", "Grovel"],
      "Ümit": ["Alpina", "Explore", "Magnetic", "Stitch", "Blackmount"],
      "Babyhope": ["Akülü Araba 440", "Coupe", "X5"],
      "Pilsan": ["Fortune", "Tery Bery", "Panzer"]
    };

    let currentUser = null;
    onAuthStateChanged(auth, user => { if(user) currentUser = user; else window.location.href="login.html"; });

    // Dinamik Menü Yönetimi
    const brandSel = document.getElementById('brandSelect');
    const modelSel = document.getElementById('modelSelect');
    const colorSel = document.getElementById('colorSelect');

    function initSelectors() {
      // Markaları yükle
      const brands = Object.keys(presetData);
      fillDropdown(brandSel, brands, "Marka Seçin");
      
      // Renkleri Firebase'den çek
      onValue(ref(db, 'products'), snap => {
        let colors = new Set(["Siyah", "Beyaz", "Kırmızı", "Mavi", "Mat Siyah-Turuncu"]);
        snap.forEach(child => { if(child.val().color) colors.add(child.val().color); });
        fillDropdown(colorSel, Array.from(colors), "Renk Seçin");
      });
    }

    function fillDropdown(el, list, def) {
      el.innerHTML = `<option value="">${def}</option><option value="NEW">-- Yeni Ekle --</option>`;
      list.forEach(item => el.innerHTML += `<option value="${item}">${item}</option>`);
    }

    brandSel.onchange = () => {
      const val = brandSel.value;
      handleNewInput(val, 'brandInput', 'btnBrandAdd');
      if(presetData[val]) fillDropdown(modelSel, presetData[val], "Model Seçin");
      else modelSel.innerHTML = '<option value="NEW">-- Yeni Ekle --</option>';
      modelSel.disabled = false;
    };

    modelSel.onchange = () => handleNewInput(modelSel.value, 'modelInput', 'btnModelAdd');
    colorSel.onchange = () => handleNewInput(colorSel.value, 'colorInput', 'btnColorAdd');

    function handleNewInput(val, inputId, btnId) {
      const show = (val === 'NEW');
      document.getElementById(inputId).style.display = show ? 'inline' : 'none';
      document.getElementById(btnId).style.display = show ? 'inline' : 'none';
    }

    // "Ekle" Buton Fonksiyonları
    document.getElementById('btnBrandAdd').onclick = () => addToDrop(brandSel, 'brandInput');
    document.getElementById('btnModelAdd').onclick = () => addToDrop(modelSel, 'modelInput');
    document.getElementById('btnColorAdd').onclick = () => addToDrop(colorSel, 'colorInput');

    function addToDrop(sel, inpId) {
      const val = document.getElementById(inpId).value;
      if(!val) return;
      const opt = document.createElement('option');
      opt.value = val; opt.text = val;
      sel.add(opt); sel.value = val;
      handleNewInput(val, inpId, ''); // Gizle
    }

    // Form Gönderimi
    document.getElementById('productForm').onsubmit = async (e) => {
      e.preventDefault();
      const status = document.getElementById('uploadStatus');
      status.innerText = "Kaydediliyor...";

      const file = document.getElementById('imageInput').files[0];
      let imgUrl = "";

      if(file) {
        const sRef_ = sRef(storage, `products/${Date.now()}_${file.name}`);
        const snap = await uploadBytes(sRef_, file);
        imgUrl = await getDownloadURL(snap.ref);
      }

      const newProd = {
        type: document.getElementById('typeSelect').value,
        brand: brandSel.value,
        model: modelSel.value,
        wheel_size: document.getElementById('wheelSelect').value,
        color: colorSel.value,
        buy_price: document.getElementById('buyPrice').value,
        sell_price: document.getElementById('sellPrice').value,
        stock_quantity: document.getElementById('stockQty').value,
        image_url: imgUrl,
        created_at: Date.now()
      };

      push(ref(db, 'products'), newProd).then(() => {
        status.innerText = "Ürün Başarıyla Eklendi!";
        document.getElementById('productForm').reset();
      });
    };

    initSelectors();
    document.querySelector('.menu-button').onclick = () => document.querySelector('.menu-items').classList.toggle('active');
  </script>
</body>
</html>
