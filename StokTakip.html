<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Depo Yönetimi | Yeni Ankara Motor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        :root { --primary: #7098e2; --bg: #f4f7f6; --success: #28a745; --danger: #dc3545; --dark: #2c3e50; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 30px; }
        
        .navbar { background: var(--primary); padding: 15px; display: flex; justify-content: space-around; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .navbar a { color: white; text-decoration: none; font-weight: bold; font-size: 12px; text-transform: uppercase; }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        .header-title { text-align: center; color: var(--dark); margin-bottom: 20px; }
        
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #eee; }
        h3 { margin-top: 0; font-size: 16px; color: var(--dark); display: flex; align-items: center; gap: 8px; }

        /* Tarayıcı Butonları */
        .scanner-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .scan-btn { padding: 15px; border-radius: 12px; border: none; background: var(--dark); color: white; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .scan-btn i { font-size: 20px; }
        
        #video-container { display: none; margin-bottom: 15px; border-radius: 15px; overflow: hidden; position: relative; background: #000; border: 3px solid var(--primary); }
        video { width: 100%; height: auto; display: block; }
        .close-scanner { position: absolute; top: 10px; right: 10px; background: rgba(220, 53, 69, 0.9); color: white; border: none; padding: 10px 15px; border-radius: 50%; z-index: 10; font-weight: bold; }

        input#searchInp { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; box-sizing: border-box; background: #f9f9f9; outline: none; }
        .search-results { border: 1px solid #eee; max-height: 200px; overflow-y: auto; display: none; background: white; border-radius: 12px; margin-top: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .result-item { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .result-item:last-child { border-bottom: none; }

        /* Liste Öğeleri */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .item-info strong { display: block; font-size: 15px; color: var(--dark); }
        .item-info small { color: #777; }

        .qty-controls { display: flex; align-items: center; gap: 12px; }
        .qty-controls button { width: 35px; height: 35px; border-radius: 10px; border: 1px solid #ddd; background: white; font-size: 18px; cursor: pointer; font-weight: bold; }
        .remove-btn { color: var(--danger); background: none; border: none; font-size: 18px; margin-left: 10px; cursor: pointer; }

        .action-buttons { display: flex; gap: 12px; margin-top: 20px; }
        .btn { flex: 1; padding: 18px; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.3s; }
        .btn:active { transform: scale(0.96); }
    </style>
</head>
<body>

    <div class="navbar">
        <a href="index.html">PANEL</a>
        <a href="ProductUpdate.html">LİSTE</a>
        <a href="NewProduct.html">YENİ EKLE</a>
    </div>

    <div class="container">
        <div class="header-title">
            <h2>YENİ ANKARA MOTOR</h2>
            <p>Akıllı Depo Yönetimi</p>
        </div>

        <div class="card">
            <div class="scanner-actions">
                <button class="scan-btn" onclick="startCamera()">
                    <i class="fas fa-camera"></i>
                    <span>Kamerayı Aç</span>
                </button>
                <button class="scan-btn" style="background: var(--primary);" onclick="document.getElementById('galleryInp').click()">
                    <i class="fas fa-image"></i>
                    <span>Galeriden Seç</span>
                </button>
                <input type="file" id="galleryInp" accept="image/*" style="display:none" onchange="scanFromGallery(event)">
            </div>

            <div id="video-container">
                <button class="close-scanner" onclick="stopCamera()">X</button>
                <video id="video"></video>
            </div>

            <input type="text" id="searchInp" placeholder="Model veya Renk Ara...">
            <div id="results" class="search-results"></div>
        </div>

        <div class="card">
            <h3><i class="fas fa-tasks"></i> İşlem Listesi</h3>
            <div id="actionList">
                <p style="color: #888; text-align: center; padding: 20px;">Ürün okutun veya arayın.</p>
            </div>
            
            <div class="action-buttons">
                <button class="btn" style="background: var(--success);" onclick="processStock('ekle')">STOK EKLE (+)</button>
                <button class="btn" style="background: var(--danger);" onclick="processStock('cikar')">STOKTAN DÜŞ (-)</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBSCuSjLtRxCicBpiYE4zV_CQ6iF23CMos", authDomain: "ceit133-mses.firebaseapp.com", databaseURL: "https://ceit133-mses-default-rtdb.firebaseio.com", projectId: "ceit133-mses", appId: "1:803859950218:web:48b897035bb041d1799b73" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let allProducts = [], selectedItems = [];
        const codeReader = new ZXing.BrowserMultiFormatReader();

        onAuthStateChanged(auth, user => { if (!user) window.location.href = "login.html"; });

        onValue(ref(db, 'products'), snap => {
            allProducts = [];
            snap.forEach(c => { let p = c.val(); p.key = c.key; allProducts.push(p); });
        });

        // --- BARKOD İŞLEME MANTIĞI ---
        function handleScanSuccess(code) {
            const found = allProducts.find(p => p.barcode === code);
            if(found) {
                if(!selectedItems.find(i => i.key === found.key)) {
                    selectedItems.push({...found, actionQty: 1});
                    renderActionList();
                    if (navigator.vibrate) navigator.vibrate(100);
                }
            } else {
                if(confirm("Bu barkod (" + code + ") sistemde kayıtlı değil. Yeni ürün olarak kaydetmek ister misiniz?")) {
                    window.location.href = "NewProduct.html?barcode=" + code;
                }
            }
        }

        window.startCamera = async () => {
            document.getElementById('video-container').style.display = 'block';
            try {
                const videoInputDevices = await codeReader.listVideoInputDevices();
                const backCamera = videoInputDevices[videoInputDevices.length - 1].deviceId;
                codeReader.decodeFromVideoDevice(backCamera, 'video', (result) => {
                    if (result) {
                        handleScanSuccess(result.text);
                        stopCamera();
                    }
                });
            } catch (err) { alert("Kamera hatası: " + err); }
        };

        window.stopCamera = () => { codeReader.reset(); document.getElementById('video-container').style.display = 'none'; };

        window.scanFromGallery = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const imgUrl = URL.createObjectURL(file);
            try {
                const result = await codeReader.decodeFromImageUrl(imgUrl);
                handleScanSuccess(result.text);
            } catch (err) { alert("Barkod okunamadı."); }
        };

        // --- MANUEL ARAMA VE LİSTELEME ---
        searchInp.oninput = () => {
            const val = searchInp.value.toLowerCase();
            results.innerHTML = "";
            if(val.length < 2) { results.style.display = "none"; return; }
            const filtered = allProducts.filter(p => (p.brand + " " + p.model + " " + p.color).toLowerCase().includes(val));
            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = "result-item";
                div.innerHTML = `<strong>${p.brand} ${p.model}</strong> <small>(${p.color}) - Stok: ${p.stock}</small>`;
                div.onclick = () => {
                    if(!selectedItems.find(i => i.key === p.key)) { selectedItems.push({...p, actionQty: 1}); renderActionList(); }
                    results.style.display = "none"; searchInp.value = "";
                };
                results.appendChild(div);
            });
            results.style.display = filtered.length ? "block" : "none";
        };

        window.updateQty = (key, delta) => {
            const item = selectedItems.find(i => i.key === key);
            item.actionQty = Math.max(1, item.actionQty + delta);
            renderActionList();
        };

        window.removeItem = (key) => {
            selectedItems = selectedItems.filter(i => i.key !== key);
            renderActionList();
        };

        function renderActionList() {
            const listDiv = document.getElementById('actionList');
            if(selectedItems.length === 0) { listDiv.innerHTML = '<p style="color:#888; text-align:center; padding:20px;">Ürün okutun veya arayın.</p>'; return; }
            listDiv.innerHTML = "";
            selectedItems.forEach(i => {
                listDiv.innerHTML += `
                    <div class="list-item">
                        <div class="item-info">
                            <strong>${i.brand} ${i.model}</strong>
                            <small>${i.color} | Mevcut: ${i.stock}</small>
                        </div>
                        <div class="qty-controls">
                            <button onclick="updateQty('${i.key}', -1)">-</button>
                            <span>${i.actionQty}</span>
                            <button onclick="updateQty('${i.key}', 1)">+</button>
                            <button onclick="removeItem('${i.key}')" class="remove-btn"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
        }

        window.processStock = async (type) => {
            if(!selectedItems.length) return alert("Listede ürün yok!");
            if(!confirm("İşlem onaylanıyor mu?")) return;
            const email = auth.currentUser.email;
            try {
                for(let i of selectedItems) {
                    const currentS = parseInt(i.stock) || 0;
                    const newS = type === 'ekle' ? (currentS + i.actionQty) : (currentS - i.actionQty);
                    await update(ref(db, `products/${i.key}`), { stock: newS });
                    await push(ref(db, 'deleted_products'), { brand: i.brand, model: i.model, color: i.color, qty: i.actionQty, type: type==='ekle'?'Giriş':'Çıkış', user: email, date: Date.now() });
                }
                alert("İşlem Başarıyla Tamamlandı!"); selectedItems = []; renderActionList();
            } catch (err) { alert("Hata: " + err.message); }
        };
    </script>
</body>
</html>
